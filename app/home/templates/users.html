{% extends "base-site.html" %} {% block title %} Configure {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %} {% block content %}

<!-- ======= Header tools ======= -->

<div style="width: 100%; display: grid; padding: 5px; margin: 0 auto; background-color: #27293d">
	<div class="header-tools" style="justify-self: flex-end; font-size: 20px; padding-right: 20px; color: #278aed">[SYSTEM USERS]</div>
</div>
<div style="display: grid; grid-template-columns: 1fr;">
	<div id="user-table-hdr"></div>
	<div id="user-table"></div>


	<div class="footer-tools" style="background-color: #27293d; padding: 16px 16px 16px 50px; display: grid; grid-template-columns: 1fr 1fr">
		<div>
			<div
				class="btn btn-simple btn-twitter"
				id="data-package-delete"
				onclick="deleteDataPackage()"
				style="color: #278aed80; border-color: #278aed80; display: inline-flex"
			>
				<span>DELETE</span> <span id="del-count">&nbsp;</span>
			</div>
			&nbsp;&nbsp;&nbsp;
			<button class="btn btn-simple btn-twitter" onclick="addUserToggle()" style="color: #278aed; border-color: #278aed">ADD</button>
		</div>
		
	</div>


	<div style="display: none" id="addUser">
		<div style="display: grid; width: 80%; padding: 10px 0px;
		margin: 0 auto; grid-template-columns: 1fr 100px 100px 180px 1fr; gap: 20px">
			<div><input type="text" class="form-control" id="name1" value="" placeholder="Name" /></div>
			<div><input type="text" class="form-control" id="group1" value="" placeholder="Group" /></div>
			<div><input type="text" class="form-control" id="token1" value="" placeholder="Token" /></div>
			<div><input type="text" class="form-control" id="password1" value="" placeholder="Password" /></div>
			<div><input type="text" class="form-control" id="cert1" value="" placeholder="Cert" /></div>
			
		</div>
		<div style="background-color: #27293d; padding: 10px 20px; display: grid; justify-content: end">
			<button class="btn btn-simple btn-twitter" onclick="addUser()" style="color: #278aed; border-color: #278aed">Send</button>
		</div>
	</div>


</div>


</div>
<div id="snackbar">&nbsp;</div>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script>
var ip = "204.48.30.216";


// this gets current server data
async function establishConnection() {
	console.log("Make connection");
	var socket = io.connect(`http://${ip}:19023`);


	console.log("Emit event authenticate...");

	let isAuth = await authenticate(socket);

	if (isAuth === "True") {
		getUserInfo(socket);
		
	} else {
		// throw error
	}
}

const authenticate = (socket) => {
		// socket.emit('authenticate', Â '{"Authenticate": "a@v{5]MQU><waQ;Z"}');
		socket.emit("authenticate", JSON.stringify({ Authenticate: "a@v{5]MQU><waQ;Z" }));

		return new Promise(function (resolve, reject) {
			socket.on("authentication", function (data) {
				let authenticateObject = JSON.parse(data);
console.log('object' + authenticateObject.successful);

				if (authenticateObject.successful === "True") {
					resolve("True");
				} else {
					reject("False");
				}
			});
		});
	};

const getUserInfo = (socket) => {
	console.log('calling...')
	socket.emit("systemUsers");
	console.log('calling..emitted...')
	socket.on("systemUsersUpdate", function (data) {
		let userInfoObject = JSON.parse(data);
		let tableArr = JSON.parse(data).SystemUsers;
		
		console.log("Print USER Response:" + JSON.stringify(userInfoObject));

			//create a Table Object
			let tablehdr = document.createElement("table");
			tablehdr.className = "table-style-hdr";

			let headerRow = tablehdr.insertRow();
			let nameHdr = headerRow.insertCell();
			nameHdr.textContent = "Name";
			nameHdr.className = "user_c1";
			let groupHdr = headerRow.insertCell();
			groupHdr.textContent = "Group";
			groupHdr.className = "user_c1";
			let tokenHdr = headerRow.insertCell();
			tokenHdr.textContent = "Token";
			tokenHdr.className = "user_c1";
			let passwordHdr = headerRow.insertCell();
			passwordHdr.textContent = "Password";
			passwordHdr.className = "user_c1";
			let certsHdr = headerRow.insertCell();
			certsHdr.textContent = "Certs";
			certsHdr.className = "user_c1";

			document.getElementById("user-table-hdr").appendChild(tablehdr);

			let table = document.createElement("table");
			table.className = "user-table-style";

			if(tableArr.length == 0) {
				
				let no_recs = table.insertRow();
				no_recs.className = "row-color-nohover";

				let noRecsCell = no_recs.insertCell();
				noRecsCell.textContent = "No Records";
				noRecsCell.className = "user-cell-style-1";

				document.getElementById("user-table").appendChild(table);
			} else {

				for (let [index, row] of tableArr.entries()) {
				let t_row = table.insertRow(index);
				t_row.className = "row-color-nohover";

				let nameCell = t_row.insertCell();
				nameCell.textContent = row.Name;
				nameCell.className = "user-cell-style-1";

				let groupCell = t_row.insertCell();
				groupCell.textContent = row.Group;
				groupCell.className = "user-cell-style-1";

				let tokenCell = t_row.insertCell();
				tokenCell.textContent = row.Token;
				tokenCell.className = "user-cell-style-1";

				let passwordCell = t_row.insertCell();
				passwordCell.textContent = row.Password;
				passwordCell.className = "user-cell-style-1";

				let certsCell = t_row.insertCell();
				certsCell.textContent = row.Password;
				certsCell.className = "user-cell-style-1";

			}

			document.getElementById("user-table").appendChild(table);

			}

			
			

	});
	
};

// missing FederationServerService

function addUserToggle() {
		var x = document.getElementById("addUser");
		if (x.style.display === "none") {
			x.style.display = "block";
			x.style.padding = "10px 0px"
		} else {
			x.style.display = "none";
		}
	}


	const addUser = async () => {
		
		if (document.getElementById("name1").value === "") {
			snackFunction("Name field is mandatory");
			return false;
		} else if (document.getElementById("group1").value === "") {
			snackFunction("Group field is mandatory");
			return false;
		} else if (document.getElementById("token1").value === "") {
			snackFunction("Token field is mandatory");
			return false;
		} else if (document.getElementById("password1").value === "") {
			snackFunction("Password field is mandatory");
			return false;
		} else if (document.getElementById("cert1").value === "") {
			snackFunction("Certification field is mandatory");
			return false;
		}


		let obj = {
	"SystemUsers": [
		  {
			  Name: document.getElementById("name1").value, 
			  Group: document.getElementById("group1").value, 
			  Token: document.getElementById("token1").value,  
			  Password: document.getElementById("password1").value,  
			  Certs: document.getElementById("cert1").value
			}]
		 };
				
		
		var socket = io.connect(`http://${ip}:19023`);


		console.log("Emit event authenticate...");

		let isAuth = await authenticate(socket);

		if (isAuth === "True") {
			socket.emit("addSystemUser", JSON.stringify(obj));
			document.getElementById("name1").value = "";
			document.getElementById("group1").value = "";
			document.getElementById("token1").value = "";
			document.getElementById("password1").value = "";
			document.getElementById("cert1").value = "";
			addUserToggle();
			getUserInfo(socket);
			
		} else {
			// throw error
		}
	}


	function snackFunction(message) {
		// Get the snackbar DIV
		var x = document.getElementById("snackbar");
		document.getElementById("snackbar").textContent = message;

		// Add the "show" class to DIV
		x.className = "show";

		// After 3 seconds, remove the show class from DIV
		setTimeout(function () {
			x.className = x.className.replace("show", "");
		}, 3000);
	}

</script>
<script>
	establishConnection();
</script>
{% endblock javascripts %}
<!-- color: #3ea1ec;
border-color: #3ea1ec; -->


<!-- {
	"SystemUsers": [
		  {"Name": "Dan", "Group": "Yellow", "Token": "", "Password": "", "Certs": "true"},
		  {"Name": "Joe", "Group": "Blue", "Token": "", "Password": "", "Certs": "true"},
		  {"Name": "Bill", "Group": "Red", "Token": "", "Password": "", "Certs": "true"}
	]
 } -->

 <!-- Event: addSystemUser -->